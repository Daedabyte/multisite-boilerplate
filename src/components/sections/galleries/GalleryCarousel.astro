---
/**
 * GalleryCarousel
 *
 * Sliding carousel for image galleries with navigation and autoplay.
 * Touch-friendly with swipe support on mobile devices.
 *
 * @variant carousel
 * @since 1.0.0
 *
 * Best for: Featured work, testimonial images, hero galleries
 * Avoid when: Need to show all images at once, or more than 20 images
 *
 * @example
 * <GalleryCarousel
 *   heading="Featured Projects"
 *   items={[
 *     { image: { src: '/img1.jpg', alt: 'Project 1' }, title: 'Project One' }
 *   ]}
 *   slidesPerView={3}
 *   autoplay={true}
 *   showArrows={true}
 *   showDots={true}
 * />
 */

import type { GalleryCarouselProps } from './types';
import Container from '@components/ui/Container.astro';

interface Props extends GalleryCarouselProps {}

const {
  heading,
  subheading,
  items,
  slidesPerView = 3,
  step = 1,
  autoplay = false,
  autoplayInterval = 5000,
  showArrows = true,
  showDots = true,
  loop = false,
  aspectRatio = 'landscape',
  lightbox = false,
  keyboard = true,
  background,
  container,
  class: className,
  classList,
  id = 'gallery',
  ...attrs
} = Astro.props;

// Calculate actual step value ('max' means use slidesPerView)
const stepValue = step === 'max' ? slidesPerView : step;

const sectionClasses = [
  'gallery',
  'gallery--carousel',
  `gallery--aspect-${aspectRatio}`,
  background?.variant === 'alt' && 'gallery--alt',
  background?.variant === 'dark' && 'gallery--dark',
  className,
  classList,
].filter(Boolean).join(' ');

const carouselId = `carousel-${id}`;
const galleryId = `gallery-${id}`;
---

<section
  id={id}
  class={sectionClasses}
  data-gallery={lightbox ? galleryId : undefined}
  data-gallery-keyboard={lightbox ? (keyboard ? 'true' : 'false') : undefined}
  {...attrs}
>
  <Container {...container}>
    {(heading || subheading) && (
      <div class="gallery__header">
        {heading && <h2 class="gallery__heading">{heading}</h2>}
        {subheading && <p class="gallery__subheading">{subheading}</p>}
      </div>
    )}

    <div
      class="carousel"
      data-carousel={carouselId}
      data-carousel-autoplay={autoplay ? 'true' : 'false'}
      data-carousel-interval={autoplayInterval}
      data-carousel-loop={loop ? 'true' : 'false'}
      data-carousel-slides-per-view={slidesPerView}
      data-carousel-step={stepValue}
      role="region"
      aria-roledescription="carousel"
      aria-label={heading || 'Image gallery'}
    >
      <div class="carousel__viewport">
        <div class="carousel__track" data-carousel-track>
          {items.map((item, index) => (
            <div
              class="carousel__slide"
              role="group"
              aria-roledescription="slide"
              aria-label={`${index + 1} of ${items.length}`}
            >
              <figure class="gallery__item">
                {lightbox ? (
                  <button
                    type="button"
                    class="gallery__trigger"
                    data-gallery-trigger={galleryId}
                    data-gallery-index={index}
                    aria-label={`View ${item.title || `image ${index + 1}`}`}
                  >
                    <img
                      src={typeof item.image.src === 'string' ? item.image.src : item.image.src.src}
                      alt={item.image.alt}
                      class="gallery__image"
                      loading={index < slidesPerView + 1 ? 'eager' : 'lazy'}
                    />
                    {(item.title || item.description) && (
                      <figcaption class="gallery__caption">
                        {item.title && <span class="gallery__title">{item.title}</span>}
                        {item.description && <span class="gallery__description">{item.description}</span>}
                      </figcaption>
                    )}
                  </button>
                ) : item.href ? (
                  <a href={item.href} class="gallery__link">
                    <img
                      src={typeof item.image.src === 'string' ? item.image.src : item.image.src.src}
                      alt={item.image.alt}
                      class="gallery__image"
                      loading={index < slidesPerView + 1 ? 'eager' : 'lazy'}
                    />
                    {(item.title || item.description) && (
                      <figcaption class="gallery__caption">
                        {item.title && <span class="gallery__title">{item.title}</span>}
                        {item.description && <span class="gallery__description">{item.description}</span>}
                      </figcaption>
                    )}
                  </a>
                ) : (
                  <>
                    <img
                      src={typeof item.image.src === 'string' ? item.image.src : item.image.src.src}
                      alt={item.image.alt}
                      class="gallery__image"
                      loading={index < slidesPerView + 1 ? 'eager' : 'lazy'}
                    />
                    {(item.title || item.description) && (
                      <figcaption class="gallery__caption">
                        {item.title && <span class="gallery__title">{item.title}</span>}
                        {item.description && <span class="gallery__description">{item.description}</span>}
                      </figcaption>
                    )}
                  </>
                )}
              </figure>
            </div>
          ))}
        </div>
      </div>

      {showArrows && items.length > slidesPerView && (
        <div class="carousel__nav">
          <button
            type="button"
            class="carousel__arrow carousel__arrow--prev"
            data-carousel-prev
            aria-label="Previous slide"
          >
            <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="carousel__arrow carousel__arrow--next"
            data-carousel-next
            aria-label="Next slide"
          >
            <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
          </button>
        </div>
      )}

      {showDots && items.length > slidesPerView && (
        <div class="carousel__dots" role="tablist" aria-label="Slide navigation">
          {items.slice(0, Math.ceil(items.length / slidesPerView)).map((_, index) => (
            <button
              type="button"
              class={`carousel__dot ${index === 0 ? 'carousel__dot--active' : ''}`}
              data-carousel-dot={index}
              role="tab"
              aria-selected={index === 0 ? 'true' : 'false'}
              aria-label={`Go to slide ${index + 1}`}
            ></button>
          ))}
        </div>
      )}
    </div>

    <slot />
  </Container>
</section>

{lightbox && (
  <div
    class="gallery-lightbox"
    data-gallery-lightbox={galleryId}
    role="dialog"
    aria-modal="true"
    aria-label="Image gallery"
    hidden
  >
    <div class="gallery-lightbox__backdrop" data-gallery-close></div>
    <div class="gallery-lightbox__content">
      <button
        type="button"
        class="gallery-lightbox__close"
        data-gallery-close
        aria-label="Close gallery"
      >
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>

      <button
        type="button"
        class="gallery-lightbox__nav gallery-lightbox__nav--prev"
        data-gallery-prev
        aria-label="Previous image"
      >
        <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
      </button>

      <div class="gallery-lightbox__stage">
        <img
          class="gallery-lightbox__image"
          src=""
          alt=""
          data-gallery-image
        />
        <div class="gallery-lightbox__caption" data-gallery-caption></div>
      </div>

      <button
        type="button"
        class="gallery-lightbox__nav gallery-lightbox__nav--next"
        data-gallery-next
        aria-label="Next image"
      >
        <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
      </button>

      <div class="gallery-lightbox__counter" data-gallery-counter></div>
    </div>
  </div>
)}

<style lang="scss" is:global>
  @use './galleries.scss';
</style>
