---
/**
 * SideNav
 *
 * Sidebar navigation component with up to 3 levels of depth.
 * Supports sticky/fixed positioning and collapsible sections.
 *
 * @since 1.0.0
 *
 * Best for: Documentation pages, settings panels, dashboards
 */

import type { BaseProps } from '@types';

// ===================================
// SideNav Types
// ===================================

/** Third level nav item (max depth) */
export interface SideNavItemL3 {
  /** Display label */
  label: string;
  /** Link URL or anchor */
  href: string;
  /** Icon class (optional) */
  icon?: string;
}

/** Second level nav item with optional children */
export interface SideNavItemL2 {
  /** Display label */
  label: string;
  /** Link URL or anchor */
  href?: string;
  /** Icon class (optional) */
  icon?: string;
  /** Third level items */
  children?: SideNavItemL3[];
}

/** Top level nav item with optional children */
export interface SideNavItemL1 {
  /** Display label */
  label: string;
  /** Link URL or anchor */
  href?: string;
  /** Icon class (optional) */
  icon?: string;
  /** Second level items */
  children?: SideNavItemL2[];
}

/** Position behavior for SideNav */
export type SideNavPosition = 'static' | 'sticky' | 'fixed';

/** Props for SideNav component */
interface Props extends BaseProps {
  /** Navigation items (max 3 levels deep) */
  items: SideNavItemL1[];
  /** Position behavior */
  position?: SideNavPosition;
  /** Top offset for sticky/fixed positioning */
  topOffset?: string;
  /** Show active state based on current URL */
  highlightActive?: boolean;
  /** Title/heading for the nav */
  title?: string;
  /** Collapsible sections */
  collapsible?: boolean;
  /** Default expanded state for collapsible sections */
  defaultExpanded?: boolean;
}

const {
  items,
  position = 'sticky',
  topOffset = 'var(--space-24)',
  highlightActive = true,
  title,
  collapsible = false,
  defaultExpanded = true,
  classList,
  id,
  ...attrs
} = Astro.props;

const currentPath = Astro.url.pathname;
const currentHash = Astro.url.hash;

// Check if a link is active
function isActive(href: string | undefined): boolean {
  if (!href || !highlightActive) return false;
  if (href.startsWith('#')) {
    return currentHash === href;
  }
  return currentPath === href || currentPath.startsWith(href + '/');
}

// Check if any child is active (for parent highlighting)
function hasActiveChild(item: SideNavItemL1 | SideNavItemL2): boolean {
  if (!item.children) return false;
  return item.children.some(child => {
    if (isActive(child.href)) return true;
    if ('children' in child && child.children) {
      return child.children.some(grandchild => isActive(grandchild.href));
    }
    return false;
  });
}

const style = position !== 'static' ? `--side-nav-top: ${topOffset};` : undefined;
---

<nav
  id={id}
  class:list={[
    'side-nav',
    `side-nav--${position}`,
    collapsible && 'side-nav--collapsible',
    classList
  ]}
  style={style}
  aria-label={title || 'Side navigation'}
  {...attrs}
>
  {title && <h2 class="side-nav__title">{title}</h2>}

  <ul class="side-nav__list side-nav__list--l1">
    {items.map((l1Item) => {
      const l1Active = isActive(l1Item.href) || hasActiveChild(l1Item);
      const l1HasChildren = l1Item.children && l1Item.children.length > 0;
      const l1Expanded = defaultExpanded || l1Active;

      return (
        <li class:list={['side-nav__item', 'side-nav__item--l1', l1Active && 'side-nav__item--active']}>
          <div class="side-nav__row">
            {l1Item.href ? (
              <a href={l1Item.href} class:list={['side-nav__link', 'side-nav__link--l1', isActive(l1Item.href) && 'side-nav__link--active']}>
                {l1Item.icon && <i class={l1Item.icon} aria-hidden="true"></i>}
                <span>{l1Item.label}</span>
              </a>
            ) : (
              <span class:list={['side-nav__label', 'side-nav__label--l1', l1Active && 'side-nav__label--active']}>
                {l1Item.icon && <i class={l1Item.icon} aria-hidden="true"></i>}
                <span>{l1Item.label}</span>
              </span>
            )}
            {collapsible && l1HasChildren && (
              <button
                type="button"
                class="side-nav__toggle"
                aria-expanded={l1Expanded ? 'true' : 'false'}
                data-side-nav-toggle
              >
                <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
              </button>
            )}
          </div>

          {l1HasChildren && (
            <ul
              class:list={['side-nav__list', 'side-nav__list--l2', !l1Expanded && collapsible && 'side-nav__list--collapsed']}
              data-side-nav-submenu
            >
              {l1Item.children!.map((l2Item) => {
                const l2Active = isActive(l2Item.href) || hasActiveChild(l2Item);
                const l2HasChildren = l2Item.children && l2Item.children.length > 0;
                const l2Expanded = defaultExpanded || l2Active;

                return (
                  <li class:list={['side-nav__item', 'side-nav__item--l2', l2Active && 'side-nav__item--active']}>
                    <div class="side-nav__row">
                      {l2Item.href ? (
                        <a href={l2Item.href} class:list={['side-nav__link', 'side-nav__link--l2', isActive(l2Item.href) && 'side-nav__link--active']}>
                          {l2Item.icon && <i class={l2Item.icon} aria-hidden="true"></i>}
                          <span>{l2Item.label}</span>
                        </a>
                      ) : (
                        <span class:list={['side-nav__label', 'side-nav__label--l2', l2Active && 'side-nav__label--active']}>
                          {l2Item.icon && <i class={l2Item.icon} aria-hidden="true"></i>}
                          <span>{l2Item.label}</span>
                        </span>
                      )}
                      {collapsible && l2HasChildren && (
                        <button
                          type="button"
                          class="side-nav__toggle"
                          aria-expanded={l2Expanded ? 'true' : 'false'}
                          data-side-nav-toggle
                        >
                          <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
                        </button>
                      )}
                    </div>

                    {l2HasChildren && (
                      <ul
                        class:list={['side-nav__list', 'side-nav__list--l3', !l2Expanded && collapsible && 'side-nav__list--collapsed']}
                        data-side-nav-submenu
                      >
                        {l2Item.children!.map((l3Item) => (
                          <li class:list={['side-nav__item', 'side-nav__item--l3', isActive(l3Item.href) && 'side-nav__item--active']}>
                            <a href={l3Item.href} class:list={['side-nav__link', 'side-nav__link--l3', isActive(l3Item.href) && 'side-nav__link--active']}>
                              {l3Item.icon && <i class={l3Item.icon} aria-hidden="true"></i>}
                              <span>{l3Item.label}</span>
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          )}
        </li>
      );
    })}
  </ul>
</nav>

<script>
  function initSideNav() {
    const toggles = document.querySelectorAll('[data-side-nav-toggle]');

    toggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');

        const submenu = toggle.closest('.side-nav__item')?.querySelector('[data-side-nav-submenu]');
        if (submenu) {
          submenu.classList.toggle('side-nav__list--collapsed', expanded);
        }
      });
    });

    // Highlight active link on hash change
    window.addEventListener('hashchange', () => {
      const hash = window.location.hash;
      document.querySelectorAll('.side-nav__link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === hash) {
          link.classList.add('side-nav__link--active');
        } else if (href?.startsWith('#')) {
          link.classList.remove('side-nav__link--active');
        }
      });
    });
  }

  initSideNav();
  document.addEventListener('astro:page-load', initSideNav);
</script>

<style lang="scss">
  @use '../../styles/abstracts' as *;

  .side-nav {
    width: 100%;
    font-size: var(--font-size-sm);

    // Position variants
    &--sticky {
      position: sticky;
      top: var(--side-nav-top, var(--space-6));
      max-height: calc(100vh - var(--side-nav-top, var(--space-6)) - var(--space-6));
      overflow-y: auto;
    }

    &--fixed {
      position: fixed;
      top: var(--side-nav-top, var(--space-6));
      max-height: calc(100vh - var(--side-nav-top, var(--space-6)) - var(--space-6));
      overflow-y: auto;
    }

    // Title
    &__title {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-neutral-500);
      margin: 0 0 var(--space-4);
      padding: 0 var(--space-3);
    }

    // Lists
    &__list {
      list-style: none;
      margin: 0;
      padding: 0;

      &--l2 {
        padding-left: var(--space-4);
        margin-top: var(--space-1);
      }

      &--l3 {
        padding-left: var(--space-4);
        margin-top: var(--space-1);
      }

      &--collapsed {
        display: none;
      }
    }

    // Items
    &__item {
      margin: 0;

      &--l1 {
        & + & {
          margin-top: var(--space-2);
        }
      }

      &--l2, &--l3 {
        & + & {
          margin-top: var(--space-1);
        }
      }
    }

    // Row wrapper for link/label + toggle
    &__row {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    // Labels (non-link section headers)
    &__label {
      display: flex;
      flex: 1;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      font-weight: var(--font-weight-semibold);
      color: var(--color-neutral-900);

      &--l1 {
        font-size: var(--font-size-sm);
      }

      &--l2 {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        color: var(--color-neutral-700);
      }

      &--active {
        color: var(--color-primary);
      }

      i:first-child {
        width: 1rem;
        text-align: center;
        font-size: 0.875em;
        color: var(--color-neutral-500);
      }

      span {
        flex: 1;
      }
    }

    // Links
    &__link {
      display: flex;
      flex: 1;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      color: var(--color-neutral-600);
      text-decoration: none;
      border-radius: var(--border-radius-base);
      transition: var(--transition-fast);

      &:hover {
        color: var(--color-neutral-900);
        background: var(--color-neutral-100);
      }

      &--active {
        color: var(--color-primary);
        background: var(--color-primary-50, rgba(var(--color-primary-rgb), 0.05));
        font-weight: var(--font-weight-medium);

        &:hover {
          color: var(--color-primary);
          background: var(--color-primary-100, rgba(var(--color-primary-rgb), 0.1));
        }
      }

      &--l1 {
        font-weight: var(--font-weight-medium);
      }

      &--l2 {
        font-size: var(--font-size-sm);
      }

      &--l3 {
        font-size: var(--font-size-sm);
        padding-left: var(--space-4);
      }

      i:first-child {
        width: 1rem;
        text-align: center;
        font-size: 0.875em;
      }
    }

    // Toggle button for collapsible
    &__toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      padding: 0;
      background: transparent;
      border: none;
      color: var(--color-neutral-400);
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: var(--transition-fast);

      &:hover {
        color: var(--color-neutral-600);
        background: var(--color-neutral-100);
      }

      i {
        font-size: 0.625rem;
        transition: transform 0.2s ease;
      }

      &[aria-expanded="false"] i {
        transform: rotate(-90deg);
      }
    }

    // Scrollbar styling
    &--sticky,
    &--fixed {
      scrollbar-width: thin;
      scrollbar-color: var(--color-neutral-300) transparent;

      &::-webkit-scrollbar {
        width: 4px;
      }

      &::-webkit-scrollbar-track {
        background: transparent;
      }

      &::-webkit-scrollbar-thumb {
        background: var(--color-neutral-300);
        border-radius: 2px;
      }
    }
  }
</style>
