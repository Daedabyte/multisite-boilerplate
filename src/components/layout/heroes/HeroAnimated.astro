---
/**
 * HeroAnimated
 *
 * Hero section with animated background effects.
 * Supports pulsing, blur-reveal, ken-burns, and parallax effects.
 *
 * @variant animated
 * @since 1.0.0
 *
 * Best for: Landing pages, portfolios, creative sites
 * Avoid when: Performance is critical on low-end devices
 *
 * @example
 * <HeroAnimated
 *   title="Welcome"
 *   subtitle="Experience the difference"
 *   backgroundImage="/images/hero.jpg"
 *   bgEffect="pulse"
 *   contentEffect="fade-up"
 * />
 */

import type { HeroBaseProps, HeroBgEffectConfig, HeroBgEffect, HeroContentEffect } from './types';
import Container from '@components/layout/Container.astro';
import Button from '@components/ui/Button.astro';

/**
 * Animated hero variant props
 */
interface Props extends HeroBaseProps {
  /** Background image URL */
  backgroundImage: string;
  /** Background effect configuration */
  bgEffect?: HeroBgEffect | HeroBgEffectConfig;
  /** Content entrance animation */
  contentEffect?: HeroContentEffect;
  /** Content animation delay in seconds */
  contentDelay?: number;
  /** Overlay opacity (0-1) */
  overlayOpacity?: number;
  /** Overlay color (CSS color value) */
  overlayColor?: string;
}

const {
  title,
  subtitle,
  actions = [],
  size = 'full',
  alignment = 'center',
  backgroundImage,
  bgEffect = 'none',
  contentEffect = 'fade-up',
  contentDelay = 0.3,
  overlayOpacity = 0.5,
  overlayColor = '#000',
  container,
  classList,
  id = 'hero',
  ...attrs
} = Astro.props;

// Normalize bgEffect to config object
const effectConfig: HeroBgEffectConfig = typeof bgEffect === 'string'
  ? { type: bgEffect }
  : bgEffect;

// Default values per effect type
const effectDefaults: Record<HeroBgEffect, Partial<HeroBgEffectConfig>> = {
  none: {},
  pulse: { duration: 8, scale: 1.1, loop: true, easing: 'ease-in-out' },
  'blur-reveal': { duration: 2, blurAmount: 20, delay: 0.2, easing: 'ease-out' },
  'ken-burns': { duration: 20, scale: 1.15, loop: true, easing: 'linear' },
  parallax: { scale: 1.2 },
};

const defaults = effectDefaults[effectConfig.type] || {};
const effect = {
  type: effectConfig.type,
  duration: effectConfig.duration ?? defaults.duration ?? 8,
  delay: effectConfig.delay ?? defaults.delay ?? 0,
  scale: effectConfig.scale ?? defaults.scale ?? 1.1,
  blurAmount: effectConfig.blurAmount ?? defaults.blurAmount ?? 20,
  loop: effectConfig.loop ?? defaults.loop ?? false,
  easing: effectConfig.easing ?? defaults.easing ?? 'ease-in-out',
};

// Build CSS custom properties for animations
const cssVars = [
  `--hero-bg-duration: ${effect.duration}s`,
  `--hero-bg-delay: ${effect.delay}s`,
  `--hero-bg-scale: ${effect.scale}`,
  `--hero-bg-blur: ${effect.blurAmount}px`,
  `--hero-bg-easing: ${effect.easing}`,
  `--hero-overlay-opacity: ${overlayOpacity}`,
  `--hero-overlay-color: ${overlayColor}`,
  `--hero-content-delay: ${contentDelay}s`,
].join('; ');
---

<section
  id={id}
  class:list={[
    'hero',
    'hero--animated',
    `hero--${size}`,
    `hero--${alignment}`,
    `hero--bg-${effect.type}`,
    contentEffect !== 'none' && `hero--content-${contentEffect}`,
    classList
  ]}
  style={cssVars}
  data-hero-animated
  data-bg-effect={effect.type}
  {...attrs}
>
  <div class="hero__bg-wrapper">
    <div
      class="hero__bg-image"
      style={`background-image: url(${backgroundImage})`}
    ></div>
  </div>
  <div class="hero__overlay"></div>

  <Container {...container}>
    <div class="hero__inner">
      <div class="hero__content">
        <slot name="badge" />

        <h1 class="hero__title">{title}</h1>

        {subtitle && <p class="hero__subtitle">{subtitle}</p>}

        {actions.length > 0 && (
          <div class="hero__actions">
            {actions.map((action, index) => (
              <Button
                href={action.href}
                type={action.type}
                variant={action.variant ?? (index === 0 ? 'primary' : 'secondary')}
                outline={action.outline ?? (index > 0 && !action.variant)}
                size={action.size}
                {...action.external ? { target: '_blank', rel: 'noopener noreferrer' } : {}}
              >
                {action.icon && <i class={action.icon}></i>}
                {action.label}
              </Button>
            ))}
          </div>
        )}

        <slot />
      </div>
    </div>
  </Container>
</section>

<script>
  function initAnimatedHeroes() {
    const heroes = document.querySelectorAll('[data-hero-animated]');

    heroes.forEach((hero) => {
      const effect = hero.getAttribute('data-bg-effect');

      // Parallax effect - scroll-based
      if (effect === 'parallax') {
        const bgImage = hero.querySelector('.hero__bg-image') as HTMLElement;
        if (!bgImage) return;

        const handleScroll = () => {
          const rect = hero.getBoundingClientRect();
          const scrolled = -rect.top;
          const parallaxSpeed = 0.5;

          if (rect.bottom > 0 && rect.top < window.innerHeight) {
            const yPos = scrolled * parallaxSpeed;
            bgImage.style.transform = `translate3d(0, ${yPos}px, 0) scale(var(--hero-bg-scale, 1.2))`;
          }
        };

        window.addEventListener('scroll', handleScroll, { passive: true });
        handleScroll(); // Initial position
      }

      // Trigger content animation when hero is visible
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('hero--visible');
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.1 }
      );

      observer.observe(hero);
    });
  }

  initAnimatedHeroes();
  document.addEventListener('astro:page-load', initAnimatedHeroes);
</script>

<style lang="scss" is:global>
  @use './heroes.scss';
</style>

<style lang="scss">
  @use '../../../styles/abstracts' as *;

  // ===================================
  // Animated Hero Styles
  // ===================================

  .hero--animated {
    position: relative;
    overflow: hidden;

    // Background wrapper
    .hero__bg-wrapper {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    // Background image
    .hero__bg-image {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      will-change: transform, filter;
    }

    // Overlay
    .hero__overlay {
      position: absolute;
      inset: 0;
      background-color: var(--hero-overlay-color, #000);
      opacity: var(--hero-overlay-opacity, 0.5);
      z-index: 1;
    }

    // Content positioning
    .hero__inner {
      position: relative;
      z-index: 2;
      padding-block: var(--space-16);

      @include media-up('lg') {
        padding-block: var(--space-20);
      }
    }

    // ===================================
    // Background Effects
    // ===================================

    // Pulse effect - zoom in/out loop
    &.hero--bg-pulse .hero__bg-image {
      animation: hero-pulse var(--hero-bg-duration, 8s) var(--hero-bg-easing, ease-in-out) var(--hero-bg-delay, 0s) infinite;
    }

    // Blur reveal effect - blur to sharp
    &.hero--bg-blur-reveal .hero__bg-image {
      filter: blur(var(--hero-bg-blur, 20px));
      transform: scale(var(--hero-bg-scale, 1.1));
      animation: hero-blur-reveal var(--hero-bg-duration, 2s) var(--hero-bg-easing, ease-out) var(--hero-bg-delay, 0.2s) forwards;
    }

    // Ken Burns effect - slow pan and zoom
    &.hero--bg-ken-burns .hero__bg-image {
      animation: hero-ken-burns var(--hero-bg-duration, 20s) var(--hero-bg-easing, linear) var(--hero-bg-delay, 0s) infinite alternate;
    }

    // Parallax effect - handled by JS, base scale
    &.hero--bg-parallax .hero__bg-image {
      transform: scale(var(--hero-bg-scale, 1.2));
      transition: transform 0.1s linear;
    }

    // ===================================
    // Content Effects
    // ===================================

    // Content hidden by default until visible
    &.hero--content-fade-up,
    &.hero--content-fade-in,
    &.hero--content-slide-in,
    &.hero--content-stagger {
      .hero__content {
        opacity: 0;
      }
    }

    // Fade up effect
    &.hero--content-fade-up.hero--visible .hero__content {
      animation: hero-fade-up 0.8s ease-out var(--hero-content-delay, 0.3s) forwards;
    }

    // Fade in effect
    &.hero--content-fade-in.hero--visible .hero__content {
      animation: hero-fade-in 0.8s ease-out var(--hero-content-delay, 0.3s) forwards;
    }

    // Slide in effect
    &.hero--content-slide-in.hero--visible .hero__content {
      animation: hero-slide-in 0.8s ease-out var(--hero-content-delay, 0.3s) forwards;
    }

    // Stagger effect - animate children sequentially
    &.hero--content-stagger.hero--visible .hero__content {
      opacity: 1;

      > * {
        opacity: 0;
        animation: hero-fade-up 0.6s ease-out forwards;
      }

      @for $i from 1 through 6 {
        > *:nth-child(#{$i}) {
          animation-delay: calc(var(--hero-content-delay, 0.3s) + #{$i * 0.1s});
        }
      }
    }
  }

  // ===================================
  // Keyframe Animations
  // ===================================

  @keyframes hero-pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(var(--hero-bg-scale, 1.1));
    }
  }

  @keyframes hero-blur-reveal {
    to {
      filter: blur(0);
      transform: scale(1);
    }
  }

  @keyframes hero-ken-burns {
    0% {
      transform: scale(1) translate(0, 0);
    }
    100% {
      transform: scale(var(--hero-bg-scale, 1.15)) translate(-2%, -1%);
    }
  }

  @keyframes hero-fade-up {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes hero-fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes hero-slide-in {
    from {
      opacity: 0;
      transform: translateX(-50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
