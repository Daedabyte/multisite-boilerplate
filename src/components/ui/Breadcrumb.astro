---
/**
 * Breadcrumb
 *
 * Navigation breadcrumb component with URL-based or property-based modes.
 *
 * @since 1.0.0
 *
 * Best for: Page navigation, deep site hierarchies
 * Avoid when: Single-level sites, landing pages
 *
 * @example URL-based (auto)
 * <Breadcrumb auto />
 *
 * @example Property-based (manual)
 * <Breadcrumb
 *   items={[
 *     { label: 'Products', href: '/products' },
 *     { label: 'Electronics', href: '/products/electronics' },
 *     { label: 'Laptops' }
 *   ]}
 * />
 */

import type { BaseProps } from '@types';

// ===================================
// Breadcrumb Types
// ===================================

/** Individual breadcrumb item */
export interface BreadcrumbItem {
  /** Display label */
  label: string;
  /** Link URL (optional for current/last item) */
  href?: string;
  /** Icon identifier (optional) */
  icon?: string;
}

/** Props for Breadcrumb component */
interface Props extends BaseProps {
  /** Manual breadcrumb items (if not using auto mode) */
  items?: BreadcrumbItem[];
  /** Auto-generate breadcrumbs from current URL */
  auto?: boolean;
  /** Home link configuration */
  home?: {
    label?: string;
    href?: string;
    icon?: string;
  };
  /** Separator between items */
  separator?: 'chevron' | 'slash' | 'arrow' | string;
  /** Show home icon only (no label) on mobile */
  compactHome?: boolean;
}

const {
  items,
  auto = false,
  home = { label: 'Home', href: '/', icon: 'fa-solid fa-house' },
  separator = 'chevron',
  compactHome = true,
  classList,
  id,
  ...attrs
} = Astro.props;

// Get the current URL path
const currentPath = Astro.url.pathname;

/**
 * Convert URL segment to readable label
 */
function segmentToLabel(segment: string): string {
  return segment
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

/**
 * Generate breadcrumb items from URL path
 */
function generateFromUrl(path: string): BreadcrumbItem[] {
  const segments = path.split('/').filter(Boolean);
  const breadcrumbs: BreadcrumbItem[] = [];

  let currentHref = '';

  segments.forEach((segment, index) => {
    currentHref += `/${segment}`;
    const isLast = index === segments.length - 1;

    breadcrumbs.push({
      label: segmentToLabel(segment),
      href: isLast ? undefined : currentHref,
    });
  });

  return breadcrumbs;
}

// Determine final items
const breadcrumbItems: BreadcrumbItem[] = auto
  ? generateFromUrl(currentPath)
  : items || [];

// Add home to the beginning if not already there
const allItems: BreadcrumbItem[] = [
  { label: home.label || 'Home', href: home.href || '/', icon: home.icon },
  ...breadcrumbItems,
];

/**
 * Get separator icon/character
 */
function getSeparator(sep: string): string {
  switch (sep) {
    case 'chevron':
      return 'fa-solid fa-chevron-right';
    case 'arrow':
      return 'fa-solid fa-arrow-right';
    case 'slash':
      return '';
    default:
      return sep;
  }
}

const separatorIcon = getSeparator(separator);
const isSlash = separator === 'slash';

---

<nav
  class:list={[
    'breadcrumb',
    compactHome && 'breadcrumb--compact-home',
    classList
  ]}
  aria-label="Breadcrumb"
  id={id}
  {...attrs}
>
  <ol class="breadcrumb__list" itemscope itemtype="https://schema.org/BreadcrumbList">
    {allItems.map((item, index) => {
      const isFirst = index === 0;
      const isLast = index === allItems.length - 1;
      const isHome = isFirst && item.href === '/';

      return (
        <li
          class={`breadcrumb__item ${isLast ? 'breadcrumb__item--current' : ''}`}
          itemprop="itemListElement"
          itemscope
          itemtype="https://schema.org/ListItem"
        >
          {index > 0 && (
            <span class="breadcrumb__separator" aria-hidden="true">
              {isSlash ? (
                <span class="breadcrumb__separator-text">/</span>
              ) : separatorIcon.startsWith('fa-') ? (
                <i class={separatorIcon}></i>
              ) : (
                <span class="breadcrumb__separator-text">{separatorIcon}</span>
              )}
            </span>
          )}

          {item.href && !isLast ? (
            <a
              href={item.href}
              class={`breadcrumb__link ${isHome ? 'breadcrumb__link--home' : ''}`}
              itemprop="item"
            >
              {item.icon && (
                <i class={`${item.icon} breadcrumb__icon`} aria-hidden="true"></i>
              )}
              <span
                class={`breadcrumb__label ${isHome && compactHome ? 'breadcrumb__label--sr-only-mobile' : ''}`}
                itemprop="name"
              >
                {item.label}
              </span>
            </a>
          ) : (
            <span
              class="breadcrumb__current"
              aria-current="page"
              itemprop="item"
            >
              {item.icon && (
                <i class={`${item.icon} breadcrumb__icon`} aria-hidden="true"></i>
              )}
              <span itemprop="name">{item.label}</span>
            </span>
          )}

          <meta itemprop="position" content={String(index + 1)} />
        </li>
      );
    })}
  </ol>
</nav>

<style lang="scss">
  @use '../../styles/abstracts' as *;

  .breadcrumb {
    font-size: var(--font-size-sm);

    &__list {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-2);
      margin: 0;
      padding: 0;
      list-style: none;
    }

    &__item {
      display: flex;
      align-items: center;
      gap: var(--space-2);

      &--current {
        color: var(--color-neutral-500);
      }
    }

    &__separator {
      display: flex;
      align-items: center;
      color: var(--color-neutral-400);
      font-size: 0.625rem;

      &-text {
        font-size: var(--font-size-sm);
      }
    }

    &__link {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-neutral-600);
      text-decoration: none;
      transition: color var(--transition-fast);

      &:hover,
      &:focus {
        color: var(--color-primary);
        text-decoration: underline;
      }
    }

    &__current {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-neutral-900);
      font-weight: var(--font-weight-medium);
    }

    &__icon {
      font-size: 0.875em;
    }

    &__label {
      &--sr-only-mobile {
        @include media-down('sm') {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border: 0;
        }
      }
    }

    // Compact home variant - show only icon on mobile
    &--compact-home {
      .breadcrumb__link--home {
        .breadcrumb__icon {
          font-size: 1em;
        }
      }
    }
  }
</style>
